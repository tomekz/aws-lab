---
- name: "AWS - setup kafka cluster"
  hosts: tag_Name_lab_kafka_node_{{ node_number }}
  become: true
  remote_user: ec2-user

  vars:
    node_number: "{{ node_number }}"
    ansible_python_interpreter: /usr/bin/python3.7
    zoo_servers: "{{ zoo_servers }}"
    kafka_cfg_advertised_listeners: "{{ kafka_cfg_advertised_listeners }}"

  tasks:
  - name: Create /data/kafka volume dir and setup permissions
    file:
      path: /data/kafka
      state: directory
      owner: 1001
      group: 1001
      mode: 0775
  - name: Create /data/zookeeper volume dir and setup permissions
    file:
      path: /data/zookeeper
      state: directory
      owner: 1001
      group: 1001
      mode: 0775
  - name: Copy `kafka/docker-compose-node-<node_number>.yaml` docker-compose file
    copy:
      src: "kafka/docker-compose-node-{{ node_number }}.yaml"
      dest: /home/ec2-user/
      owner: ec2-user
      group: ec2-user
      mode: 0644
  - name: Install urllib3 library
    pip:
      name: urllib3
      state: present
      version: 1.26.6
  - name: Install docker library
    pip:
      name: docker
      state: present
  - name: Install docker-compose library
    pip:
      name: docker-compose
      state: present
  - name: Verify Docker Compose file exists
    stat:
      path: "/home/ec2-user/docker-compose-node-{{ node_number }}.yaml"
    register: docker_compose_file
  - name: Create .env file
    copy:
      content: |
        ZOO_SERVERS="{{ zoo_servers }}"
        KAFKA_CFG_ADVERTISED_LISTENERS="{{ kafka_cfg_advertised_listeners }}"
      dest: /home/ec2-user/.env
  - name: deploy Docker Compose stack
    community.docker.docker_compose:
      project_src: /home/ec2-user
      files:
        - docker-compose-node-{{ node_number }}.yaml
    when: docker_compose_file.stat.exists

